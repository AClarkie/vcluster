version: v2beta1
name: vcluster

vars:
  SYNCER_IMAGE: ghcr.io/loft-sh/loft-enterprise/dev-vcluster
  K3S_IMAGE: rancher/k3s:v1.23.3-k3s1
  # Make sure you install the vcluster cli prior to running this with DevSpace
  SERVICE_CIDR: $(vcluster get service-cidr)

images:
  vcluster:
    image: ${SYNCER_IMAGE}
    rebuildStrategy: ignoreContextChanges
    target: builder
    buildKit: {}

deployments:
  vcluster:
    updateImageTags: true
    helm:
      chart:
        name: ./charts/k3s
      values:
        serviceCIDR: ${SERVICE_CIDR}
        etcd:
          replicas: 3
        api:
          replicas: 3
        controller:
          replicas: 3
        enableHA: true
        tolerations:
          - operator: "Exists"
        serviceAccount:
          create: false
          name: default
        vcluster:
          image: ${K3S_IMAGE}
        rbac:
          clusterRole:
            create: true
          role:
            extended: true
        syncer:
          image: ${SYNCER_IMAGE}

dev:
  syncer:
    imageSelector: ${SYNCER_IMAGE}
    workingDir: /vcluster-dev
    terminal:
      command: "./devspace_start.sh"
    proxyCommands:
      - command: git
      - command: remote-sh
        localCommand: sh
    ports:
    - port: 2346:2345
    sync:
    - path: ./
      excludePaths:
        - '**'
        - '!/pkg'
        - '!/cmd'
        - '!/vendor'
        - '!/hack'
        - '!/go.mod'
        - '!/go.sum'
        - '!/devspace_start.sh'
        - '!/manifests'
        - '/manifests/coredns'



commands:
  dev: |-
    devspace run-pipeline dev -n vcluster $@
  dev-crc: |-
    devspace dev -n vcluster --profile dev-crc $@
  deploy: |-
    devspace run-pipeline --profile deploy -n vcluster -d $@
  deploy-crc: |-
    devspace deploy --profile deploy-crc -n vcluster -d $@

profiles:
  - name: deploy
    patches:
      - op: remove
        path: images.vcluster.rebuildStrategy
      - op: remove
        path: images.vcluster.target

  - name: k3s
    # This profile is empty for now because the default config is for k3s
    # Keep the empty profile because it's used in the distribution matrix of the GH workflow for e2e.

  - name: k0s
    patches:
      - op: replace
        path: deployments.vcluster.helm.chart.name
        value: ./charts/k0s
      - op: remove
        path: deployments.vcluster.helm.values.vcluster.image

  - name: k8s
    patches:
      - op: replace
        path: deployments.vcluster.helm.chart.name
        value: ./charts/k8s

  - name: kind-load
    patches:
      - op: add
        path: hooks
        value:
          - name: "post-image-build-hook"
            command: |
              kind load docker-image image(vcluster):tag(vcluster)
            events: ["after:build:vcluster"]

  - name: no-cpu-requests
    patches:
      - op: replace
        path: deployments.vcluster.helm.values.syncer.resources
        value: 
          requests:
            cpu: "0"
      - op: replace
        path: deployments.vcluster.helm.values.vcluster.resources
        value: 
          requests:
            cpu: "0"
      - op: replace
        path: deployments.vcluster.helm.values.etcd.resources
        value: 
          requests:
            cpu: "0"
      - op: replace
        path: deployments.vcluster.helm.values.controller.resources
        value: 
          requests:
            cpu: "0"
      - op: replace
        path: deployments.vcluster.helm.values.api.resources
        value: 
          requests:
            cpu: "0"

  - name: sync-networkpolicies
    patches:
      - op: replace
        path: deployments.vcluster.helm.values.syncer.extraArgs
        value: ['--sync=networkpolicies']

  - name: parent-crc
    patches:
      - op: replace
        path: images.vcluster.custom
        value:
          command: ./hack/crc-podman-build.sh -t ${runtime.images.vcluster}
      - op: replace
        path: deployments.vcluster.helm.values.openshift
        value: 
          enable: true

  - name: deploy-crc
    parents:
      - profile: parent-crc

  - name: dev-crc
    parents: 
      - profile: parent-crc
    patches:
      - op: replace
        path: images.vcluster.custom
        value:
          command: ./hack/crc-podman-build.sh -t ${runtime.images.vcluster} --target=builder
